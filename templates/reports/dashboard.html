{% extends 'base.html' %}
{% load humanize %}
{% comment %} templates/reports/dashboard.html - ë³´ê³ ì„œ ëŒ€ì‹œë³´ë“œ {% endcomment %}

{% block title %}ë³´ê³ ì„œ ëŒ€ì‹œë³´ë“œ - Shopuda ERP{% endblock %}

{% block breadcrumb %}
<div class="flex items-center space-x-2">
    <i class="fas fa-home w-4 h-4"></i>
    <span class="text-gray-400 dark:text-gray-500">/</span>
    <span>ë³´ê³ ì„œ</span>
</div>
{% endblock %}

{% block content %}
<div class="space-y-8" x-data="reportsData()">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl shadow-xl text-white p-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">ğŸ“Š ë³´ê³ ì„œ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-blue-100">ë¹„ì¦ˆë‹ˆìŠ¤ ì„±ê³¼ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-blue-100 mb-1">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
                <div class="text-lg font-semibold">{{ current_time|date:"Y-m-d H:i" }}</div>
            </div>
        </div>
    </div>

    <!-- ë¹ ë¥¸ í†µê³„ ì¹´ë“œ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- ì´ ë§¤ì¶œ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ì´ ë§¤ì¶œ (30ì¼)</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        â‚©{{ total_revenue|floatformat:0|intcomma }}
                    </p>
                    <p class="text-sm {% if growth_rate >= 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %} mt-1">
                        <i class="fas {% if growth_rate >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i> 
                        {% if growth_rate >= 0 %}+{% endif %}{{ growth_rate|floatformat:1 }}%
                    </p>
                </div>
                <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                    <i class="fas fa-won-sign text-green-600 dark:text-green-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- ì´ ì£¼ë¬¸ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ì´ ì£¼ë¬¸ (30ì¼)</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        {{ total_orders|intcomma }}
                    </p>
                    <p class="text-sm text-blue-600 dark:text-blue-400 mt-1">
                        <i class="fas fa-shopping-cart"></i> í‰ê·  {{ avg_order_value|floatformat:0|intcomma }}ì›
                    </p>
                </div>
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                    <i class="fas fa-shopping-cart text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- ì¬ê³  í˜„í™© -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ì´ ìƒí’ˆ</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        {{ total_products|intcomma }}
                    </p>
                    <p class="text-sm text-orange-600 dark:text-orange-400 mt-1">
                        <i class="fas fa-exclamation-triangle"></i> {{ low_stock_count }}ê°œ ë¶€ì¡±
                    </p>
                </div>
                <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center">
                    <i class="fas fa-boxes text-orange-600 dark:text-orange-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- í”Œë«í¼ ì—°ë™ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ì—°ë™ í”Œë«í¼</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        {{ connected_platforms|intcomma }}
                    </p>
                    <p class="text-sm text-purple-600 dark:text-purple-400 mt-1">
                        <i class="fas fa-sync"></i> ì‹¤ì‹œê°„ ë™ê¸°í™”
                    </p>
                </div>
                <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                    <i class="fas fa-link text-purple-600 dark:text-purple-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- ë³´ê³ ì„œ ë¹ ë¥¸ ì•¡ì„¸ìŠ¤ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- ë³´ê³ ì„œ ë§í¬ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-file-alt text-indigo-500 mr-2"></i>
                    ë¹ ë¥¸ ë³´ê³ ì„œ ì•¡ì„¸ìŠ¤
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-3">
                    <a href="{% url 'reports:inventory' %}" 
                       class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-warehouse text-green-600 dark:text-green-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">ì¬ê³  ë³´ê³ ì„œ</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">ì¬ê³  í˜„í™© ë° ë³€ë™</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300"></i>
                        </div>
                    </a>
                    
                    <a href="{% url 'reports:sales' %}" 
                       class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-line text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">ë§¤ì¶œ ë¶„ì„</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">ì¼/ì›”ë³„ ë§¤ì¶œ ì¶”ì´</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300"></i>
                        </div>
                    </a>
                    
                    <a href="{% url 'reports:financial' %}" 
                       class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calculator text-yellow-600 dark:text-yellow-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">ì¬ë¬´ ë³´ê³ ì„œ</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">ì†ìµ ë° ë¹„ìš© ë¶„ì„</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300"></i>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- ì˜¤ëŠ˜ì˜ ì„±ê³¼ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                    ì˜¤ëŠ˜ì˜ ì„±ê³¼
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-shopping-bag text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">ì˜¤ëŠ˜ ì£¼ë¬¸</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ today_orders }}ê±´</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-green-600 dark:text-green-400">
                                â‚©{{ today_revenue|floatformat:0|intcomma }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-exchange-alt text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">ì¬ê³  ë³€ë™</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ today_stock_movements }}ê±´</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-plus text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">ì‹ ê·œ ìƒí’ˆ (7ì¼)</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ new_products_week }}ê°œ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ì„¹ì…˜ - ìˆ˜ì •ëœ ë¶€ë¶„ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- ë§¤ì¶œ ì°¨íŠ¸ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-chart-area text-blue-500 mr-2"></i>
                    ìµœê·¼ 7ì¼ ë§¤ì¶œ ì¶”ì´
                </h3>
                <div class="flex space-x-2">
                    <select class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="7">7ì¼</option>
                        <option value="14">14ì¼</option>
                        <option value="30">30ì¼</option>
                    </select>
                </div>
            </div>
            <!-- ì°¨íŠ¸ ì»¨í…Œì´ë„ˆì— ê³ ì • ë†’ì´ ì„¤ì • -->
            <div class="relative h-64 w-full">
                <canvas id="salesChart" x-ref="salesChart" class="w-full h-full"></canvas>
            </div>
        </div>

        <!-- ìƒí’ˆ ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                    ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ ë¹„ìœ¨
                </h3>
            </div>
            <!-- ì°¨íŠ¸ ì»¨í…Œì´ë„ˆì— ê³ ì • ë†’ì´ ì„¤ì • -->
            <div class="relative h-64 w-full">
                <canvas id="categoryChart" x-ref="categoryChart" class="w-full h-full"></canvas>
            </div>
        </div>
    </div>

    <!-- ìµœê·¼ í™œë™ -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
        <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-clock text-indigo-500 mr-2"></i>
                ìµœê·¼ ë³´ê³ ì„œ í™œë™
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div class="flex items-center space-x-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-download text-green-600 dark:text-green-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">ì¬ê³  ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">2ì‹œê°„ ì „</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-bar text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">ì›”ê°„ ë§¤ì¶œ ë³´ê³ ì„œ ìƒì„±</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">1ì¼ ì „</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-envelope text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">ì£¼ê°„ ë³´ê³ ì„œ ì´ë©”ì¼ ë°œì†¡</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">3ì¼ ì „</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function reportsData() {
    return {
        salesChart: null,
        categoryChart: null,
        
        init() {
            // DOMì´ ì™„ì „íˆ ì¤€ë¹„ëœ í›„ ì°¨íŠ¸ ì´ˆê¸°í™”
            this.$nextTick(() => {
                // ì¢€ ë” ê¸´ ì§€ì—°ì‹œê°„ìœ¼ë¡œ ì•ˆì •ì ì¸ ì´ˆê¸°í™” ë³´ì¥
                setTimeout(() => {
                    this.initCharts();
                }, 500);
            });
        },
        
        initCharts() {
            // ê¸°ì¡´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±°
            this.destroyCharts();
            
            try {
                // ë§¤ì¶œ ì°¨íŠ¸ ì´ˆê¸°í™”
                const salesCanvas = this.$refs.salesChart;
                if (salesCanvas && typeof Chart !== 'undefined') {
                    const salesCtx = salesCanvas.getContext('2d');
                    
                    this.salesChart = new Chart(salesCtx, {
                        type: 'line',
                        data: {
                            labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                            datasets: [{
                                label: 'ë§¤ì¶œ',
                                data: [120000, 150000, 180000, 140000, 200000, 250000, 300000],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // ì¤‘ìš”: ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ì¶¤
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return 'â‚©' + value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                }

                // ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ ì´ˆê¸°í™”
                const categoryCanvas = this.$refs.categoryChart;
                if (categoryCanvas && typeof Chart !== 'undefined') {
                    const categoryCtx = categoryCanvas.getContext('2d');
                    
                    this.categoryChart = new Chart(categoryCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['ì „ìì œí’ˆ', 'ì˜ë¥˜', 'ìƒí™œìš©í’ˆ', 'ìŠ¤í¬ì¸ ', 'ë„ì„œ'],
                            datasets: [{
                                data: [30, 25, 20, 15, 10],
                                backgroundColor: [
                                    '#3B82F6', '#10B981', '#F59E0B', 
                                    '#EF4444', '#8B5CF6'
                                ],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // ì¤‘ìš”: ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ì¶¤
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('ì°¨íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        },
        
        destroyCharts() {
            // ê¸°ì¡´ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì •ë¦¬
            if (this.salesChart) {
                this.salesChart.destroy();
                this.salesChart = null;
            }
            if (this.categoryChart) {
                this.categoryChart.destroy();
                this.categoryChart = null;
            }
        }
    }
}

// í˜ì´ì§€ê°€ ì–¸ë¡œë“œë  ë•Œ ì°¨íŠ¸ ì •ë¦¬
window.addEventListener('beforeunload', function() {
    if (window.reportsDataInstance) {
        window.reportsDataInstance.destroyCharts();
    }
});
</script>

<style>
/* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ìµœì í™” */
.chart-container {
    position: relative;
    height: 16rem; /* h-64ì™€ ë™ì¼ */
    width: 100%;
}

/* ì°¨íŠ¸ ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
canvas {
    display: block;
    box-sizing: border-box;
}

/* ë°˜ì‘í˜• ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
@media (max-width: 768px) {
    .chart-container {
        height: 12rem; /* ëª¨ë°”ì¼ì—ì„œëŠ” ì¢€ ë” ì‘ê²Œ */
    }
}

/* ì°¨íŠ¸ ë¡œë”© ìƒíƒœ ìŠ¤íƒ€ì¼ */
.chart-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 16rem;
    background-color: #f9fafb;
    border-radius: 0.5rem;
    color: #6b7280;
}

.dark .chart-loading {
    background-color: #374151;
    color: #9ca3af;
}
</style>
{% endblock %}