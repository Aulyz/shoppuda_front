{% extends 'base.html' %}
{% load humanize %}
{% load inventory_extras %}
{% comment %} templates/reports/inventory.html - ì¬ê³  ë¦¬í¬íŠ¸ í˜ì´ì§€ {% endcomment %}

{% block title %}ì¬ê³  ë¦¬í¬íŠ¸ - Shopuda ERP{% endblock %}

{% block breadcrumb %}
<div class="flex items-center space-x-2">
    <i class="fas fa-home w-4 h-4"></i>
    <span class="text-gray-400 dark:text-gray-500">/</span>
    <a href="{% url 'dashboard:home' %}" class="hover:text-gray-600 dark:hover:text-gray-300 transition-colors duration-200">ëŒ€ì‹œë³´ë“œ</a>
    <span class="text-gray-400 dark:text-gray-500">/</span>
    <span>ì¬ê³  ë¦¬í¬íŠ¸</span>
</div>
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
<style>
/* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-in-left {
    animation: slideInLeft 0.5s ease-out;
}

@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-30px); }
    to { opacity: 1; transform: translateX(0); }
}

.slide-in-right {
    animation: slideInRight 0.5s ease-out;
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
}

/* ì¹´ë“œ í˜¸ë²„ íš¨ê³¼ */
.report-card {
    transition: all 0.3s ease;
}

.report-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.dark .report-card:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
}

/* ìŠ¤íƒ¯ ì¹´ë“œ ê·¸ë¼ë””ì–¸íŠ¸ */
.stat-card-1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.stat-card-2 {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-card-3 {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-card-4 {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

/* í…Œì´ë¸” ìŠ¤íŠ¸ë¼ì´í”„ */
.table-striped tbody tr:nth-child(even) {
    background-color: rgba(249, 250, 251, 0.5);
}

.dark .table-striped tbody tr:nth-child(even) {
    background-color: rgba(31, 41, 55, 0.5);
}

.table-striped tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.05);
}

.dark .table-striped tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.1);
}

/* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
.progress-bar {
    transition: width 1s ease-in-out;
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ */
.loading-spinner {
    border: 3px solid #f3f4f6;
    border-top: 3px solid #3b82f6;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
.chart-container {
    position: relative;
    height: 300px;
}

/* ë°˜ì‘í˜• ì°¨íŠ¸ */
@media (max-width: 768px) {
    .chart-container {
        height: 250px;
    }
}

/* í•„í„° ë“œë¡­ë‹¤ìš´ */
.filter-dropdown {
    max-height: 300px;
    overflow-y: auto;
}

/* ìƒíƒœ í‘œì‹œê¸° */
.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-normal { background-color: #10b981; }
.status-low { background-color: #f59e0b; }
.status-out { background-color: #ef4444; }
.status-excess { background-color: #8b5cf6; }

/* í”„ë¦°íŠ¸ ìŠ¤íƒ€ì¼ */
@media print {
    .no-print {
        display: none !important;
    }
    
    .print-break {
        page-break-before: always;
    }
    
    body {
        font-size: 12px;
    }
    
    .report-card {
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-8" x-data="inventoryReport()" x-init="initializeReport()">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl shadow-2xl overflow-hidden fade-in">
        <div class="px-6 py-8 sm:px-8 lg:px-12">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-chart-bar text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl lg:text-4xl font-bold text-white">
                            ì¬ê³  ë¦¬í¬íŠ¸ ğŸ“Š
                        </h1>
                        <p class="text-blue-100 text-lg mt-2">
                            ì‹¤ì‹œê°„ ì¬ê³  í˜„í™© ë° ë¶„ì„ ë°ì´í„°
                        </p>
                    </div>
                </div>
                <div class="mt-6 lg:mt-0 flex flex-col sm:flex-row gap-3">
                    <button @click="exportReport('excel')" 
                            class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 text-white font-medium rounded-xl transition-all duration-200 backdrop-blur-sm">
                        <i class="fas fa-file-excel mr-2"></i>
                        Excel ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button @click="exportReport('pdf')" 
                            class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 text-white font-medium rounded-xl transition-all duration-200 backdrop-blur-sm">
                        <i class="fas fa-file-pdf mr-2"></i>
                        PDF ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button @click="window.print()" 
                            class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 text-white font-medium rounded-xl transition-all duration-200 backdrop-blur-sm no-print">
                        <i class="fas fa-print mr-2"></i>
                        ì¸ì‡„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- í•„í„° ì„¹ì…˜ -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6 slide-in-left no-print">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex items-center space-x-2">
                <i class="fas fa-filter text-gray-400 dark:text-gray-500"></i>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">í•„í„° ë° ì •ë ¬</h3>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <!-- ê¸°ê°„ ì„ íƒ -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">ê¸°ê°„:</label>
                    <input type="date" 
                           x-model="filters.startDate"
                           @change="applyFilters()"
                           class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <span class="text-gray-400">~</span>
                    <input type="date" 
                           x-model="filters.endDate"
                           @change="applyFilters()"
                           class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                </div>
                
                <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">ì¹´í…Œê³ ë¦¬:</label>
                    <select x-model="filters.category" 
                            @change="applyFilters()"
                            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">ì „ì²´</option>
                        <template x-for="category in categories" :key="category.id">
                            <option :value="category.id" x-text="category.name"></option>
                        </template>
                    </select>
                </div>
                
                <!-- ì¬ê³  ìƒíƒœ í•„í„° -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">ìƒíƒœ:</label>
                    <select x-model="filters.stockStatus" 
                            @change="applyFilters()"
                            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">ì „ì²´</option>
                        <option value="normal">ì •ìƒ</option>
                        <option value="low">ë¶€ì¡±</option>
                        <option value="out">í’ˆì ˆ</option>
                        <option value="excess">ê³¼ì¬ê³ </option>
                    </select>
                </div>
                
                <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
                <button @click="refreshReport()" 
                        :disabled="loading"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200 disabled:opacity-50">
                    <div x-show="loading" class="loading-spinner mr-2"></div>
                    <i x-show="!loading" class="fas fa-sync-alt mr-2"></i>
                    ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
        </div>
    </div>

    <!-- ìš”ì•½ í†µê³„ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 slide-in-right">
        <!-- ì´ ìƒí’ˆ ìˆ˜ -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="stat-card-1 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">ì´ ìƒí’ˆ ìˆ˜</p>
                        <p class="text-white text-3xl font-bold" x-text="stats.totalProducts || 0"></p>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-arrow-up text-white/80 text-sm mr-1"></i>
                            <span class="text-white/80 text-sm">ì „ì›” ëŒ€ë¹„ +5.2%</span>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-boxes text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì´ ì¬ê³  ê°€ì¹˜ -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="stat-card-2 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">ì´ ì¬ê³  ê°€ì¹˜</p>
                        <p class="text-white text-3xl font-bold" x-text="formatCurrency(stats.totalValue || 0)"></p>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-arrow-up text-white/80 text-sm mr-1"></i>
                            <span class="text-white/80 text-sm">ì „ì›” ëŒ€ë¹„ +12.8%</span>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-won-sign text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¶€ì¡± ì¬ê³  -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="stat-card-3 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">ë¶€ì¡± ì¬ê³ </p>
                        <p class="text-white text-3xl font-bold" x-text="stats.lowStockCount || 0"></p>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-arrow-down text-white/80 text-sm mr-1"></i>
                            <span class="text-white/80 text-sm">ì „ì›” ëŒ€ë¹„ -3.1%</span>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- í’ˆì ˆ ìƒí’ˆ -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="stat-card-4 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">í’ˆì ˆ ìƒí’ˆ</p>
                        <p class="text-white text-3xl font-bold" x-text="stats.outOfStockCount || 0"></p>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-arrow-down text-white/80 text-sm mr-1"></i>
                            <span class="text-white/80 text-sm">ì „ì›” ëŒ€ë¹„ -8.5%</span>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-times-circle text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- ì¬ê³  ìƒíƒœ ë¶„í¬ -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">ì¬ê³  ìƒíƒœ ë¶„í¬</h3>
                <div class="flex items-center space-x-2">
                    <span class="status-indicator status-normal"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">ì •ìƒ</span>
                    <span class="status-indicator status-low"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">ë¶€ì¡±</span>
                    <span class="status-indicator status-out"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">í’ˆì ˆ</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="stockStatusChart"></canvas>
            </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê°€ì¹˜ -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê°€ì¹˜</h3>
                <button @click="toggleChartType('categoryChart')" 
                        class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">
                    <i class="fas fa-exchange-alt mr-1"></i>
                    ì°¨íŠ¸ ë³€ê²½
                </button>
            </div>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ì¬ê³  ì¶”ì´ ì°¨íŠ¸ -->
    <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">ì¬ê³  ë³€ë™ ì¶”ì´</h3>
            <div class="flex items-center space-x-2">
                <select x-model="trendPeriod" 
                        @change="updateTrendChart()"
                        class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="7">ìµœê·¼ 7ì¼</option>
                    <option value="30">ìµœê·¼ 30ì¼</option>
                    <option value="90">ìµœê·¼ 90ì¼</option>
                </select>
            </div>
        </div>
        <div class="chart-container" style="height: 400px;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- ìƒì„¸ ì¬ê³  í…Œì´ë¸” -->
    <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">ìƒì„¸ ì¬ê³  í˜„í™©</h3>
                <div class="flex items-center space-x-3">
                    <!-- ê²€ìƒ‰ -->
                    <div class="relative">
                        <input type="text" 
                               x-model="searchQuery"
                               @input="searchProducts()"
                               placeholder="ìƒí’ˆ ê²€ìƒ‰..."
                               class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <!-- ì •ë ¬ -->
                    <select x-model="sortBy" 
                            @change="sortProducts()"
                            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="name">ìƒí’ˆëª…</option>
                        <option value="stock">ì¬ê³ ëŸ‰</option>
                        <option value="value">ì¬ê³ ê°€ì¹˜</option>
                        <option value="status">ìƒíƒœ</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full table-striped">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            ìƒí’ˆì •ë³´
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            ì¹´í…Œê³ ë¦¬
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            í˜„ì¬ê³ 
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            ì•ˆì „ì¬ê³ 
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            ì¬ê³ ê°€ì¹˜
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            ìƒíƒœ
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            ìµœê·¼ ì—…ë°ì´íŠ¸
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="product in filteredProducts" :key="product.id">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-12 w-12">
                                        <img :src="product.image || '/static/images/no-image.png'" 
                                             :alt="product.name"
                                             class="h-12 w-12 rounded-lg object-cover border border-gray-200 dark:border-gray-600">
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="product.name"></div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400" x-text="product.sku"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300" 
                                      x-text="product.category"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="formatNumber(product.current_stock)"></div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">ë‹¨ìœ„</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900 dark:text-white" x-text="formatNumber(product.min_stock)"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="formatCurrency(product.stock_value)"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="getStatusClass(product.status)">
                                    <span :class="getStatusIndicatorClass(product.status)" class="w-2 h-2 rounded-full mr-1.5"></span>
                                    <span x-text="getStatusText(product.status)"></span>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                <div x-text="formatDate(product.updated_at)"></div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                <span x-text="`ì´ ${totalProducts}ê°œ ìƒí’ˆ ì¤‘ ${(currentPage - 1) * pageSize + 1}-${Math.min(currentPage * pageSize, totalProducts)}ê°œ í‘œì‹œ`"></span>
            </div>
            <div class="flex items-center space-x-2">
                <button @click="prevPage()" 
                        :disabled="currentPage <= 1"
                        class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <div class="flex items-center space-x-1">
                    <template x-for="page in getPageNumbers()" :key="page">
                        <button @click="goToPage(page)" 
                                :class="page === currentPage ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'"
                                class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm transition-colors"
                                x-text="page">
                        </button>
                    </template>
                </div>
                
                <button @click="nextPage()" 
                        :disabled="currentPage >= totalPages"
                        class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ì¬ê³  ê²½ê³  ì•Œë¦¼ -->
    <div x-show="alerts.length > 0" class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-bell text-yellow-500 mr-2"></i>
                ì¬ê³  ê²½ê³  ì•Œë¦¼
            </h3>
            <span class="bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300 text-xs font-medium px-2.5 py-0.5 rounded-full" 
                  x-text="`${alerts.length}ê±´`"></span>
        </div>
        
        <div class="space-y-3">
            <template x-for="alert in alerts" :key="alert.id">
                <div class="flex items-center justify-between p-4 border border-red-200 dark:border-red-800 rounded-lg bg-red-50 dark:bg-red-900/20">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-red-800 dark:text-red-300" x-text="alert.title"></p>
                            <p class="text-sm text-red-600 dark:text-red-400" x-text="alert.message"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button @click="resolveAlert(alert.id)" 
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-check text-sm"></i>
                        </button>
                        <button @click="dismissAlert(alert.id)" 
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div x-show="loading" 
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 flex flex-col items-center space-y-4 shadow-2xl">
            <div class="loading-spinner"></div>
            <p class="text-lg font-medium text-gray-900 dark:text-white">ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
        </div>
    </div>
</div>

<script>
function inventoryReport() {
    return {
        // ë°ì´í„°
        stats: {
            totalProducts: 0,
            totalValue: 0,
            lowStockCount: 0,
            outOfStockCount: 0
        },
        products: [],
        filteredProducts: [],
        categories: [],
        alerts: [],
        
        // í•„í„°
        filters: {
            startDate: '',
            endDate: '',
            category: '',
            stockStatus: ''
        },
        
        // ê²€ìƒ‰ ë° ì •ë ¬
        searchQuery: '',
        sortBy: 'name',
        sortDirection: 'asc',
        
        // í˜ì´ì§€ë„¤ì´ì…˜
        currentPage: 1,
        pageSize: 20,
        totalProducts: 0,
        totalPages: 0,
        
        // ì°¨íŠ¸
        charts: {},
        trendPeriod: '30',
        
        // ìƒíƒœ
        loading: false,
        
        // ì´ˆê¸°í™”
        async initializeReport() {
            this.loading = true;
            try {
                await this.loadInitialData();
                await this.loadReportData();
                this.initializeCharts();
                this.loadAlerts();
            } catch (error) {
                console.error('ë¦¬í¬íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                this.showError('ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                this.loading = false;
            }
        },
        
        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        async loadInitialData() {
            // ë‚ ì§œ ë²”ìœ„ ì„¤ì • (ìµœê·¼ 30ì¼)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);
            
            this.filters.startDate = startDate.toISOString().split('T')[0];
            this.filters.endDate = endDate.toISOString().split('T')[0];
            
            // ì¹´í…Œê³ ë¦¬ ë°ì´í„° ë¡œë“œ
            this.categories = [
                { id: 1, name: 'ì „ìì œí’ˆ' },
                { id: 2, name: 'ì˜ë¥˜' },
                { id: 3, name: 'ê°€ì „ì œí’ˆ' },
                { id: 4, name: 'í™”ì¥í’ˆ' },
                { id: 5, name: 'ë„ì„œ' }
            ];
        },
        
        // ë¦¬í¬íŠ¸ ë°ì´í„° ë¡œë“œ
        async loadReportData() {
            try {
                const params = new URLSearchParams();
                
                // í•„í„° íŒŒë¼ë¯¸í„° ì¶”ê°€
                if (this.filters.startDate) params.append('start_date', this.filters.startDate);
                if (this.filters.endDate) params.append('end_date', this.filters.endDate);
                if (this.filters.category) params.append('category', this.filters.category);
                if (this.filters.stockStatus) params.append('stock_status', this.filters.stockStatus);
                if (this.searchQuery) params.append('search', this.searchQuery);
                
                // í˜ì´ì§€ë„¤ì´ì…˜ íŒŒë¼ë¯¸í„°
                params.append('page', this.currentPage);
                params.append('page_size', this.pageSize);
                params.append('sort_by', this.sortBy);
                params.append('sort_direction', this.sortDirection);
                
                const response = await fetch(`{% url 'reports:inventory_data' %}?${params.toString()}`, {
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrf-token]').content,
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    this.stats = data.stats;
                    this.filteredProducts = data.products;
                    this.categoryAnalysis = data.categoryAnalysis;
                    this.alerts = data.alerts || [];
                    
                    // í˜ì´ì§€ë„¤ì´ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
                    if (data.pagination) {
                        this.currentPage = data.pagination.currentPage;
                        this.totalPages = data.pagination.totalPages;
                        this.totalProducts = data.pagination.totalItems;
                    }
                    
                    // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
                    await this.updateAllCharts();
                } else {
                    throw new Error(data.error || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                this.showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                
                // ê¸°ë³¸ê°’ ì„¤ì •
                this.stats = {
                    totalProducts: 0,
                    totalValue: 0,
                    lowStockCount: 0,
                    outOfStockCount: 0
                };
                this.filteredProducts = [];
                this.alerts = [];
            }
        },
        
        // í•„í„° ì ìš©
        async applyFilters() {
            this.loading = true;
            await this.loadReportData();
            this.loading = false;
        },
        
        // ìƒí’ˆ ê²€ìƒ‰
        async searchProducts() {
            this.currentPage = 1; // ê²€ìƒ‰ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ë™
            await this.applyFilters();
        },
        
        // ì •ë ¬
        async sortProducts() {
            await this.applyFilters();
        },
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        updatePaginatedProducts(allProducts) {
            const startIndex = (this.currentPage - 1) * this.pageSize;
            const endIndex = startIndex + this.pageSize;
            this.filteredProducts = allProducts.slice(startIndex, endIndex);
        },
        
        // í˜ì´ì§€ ì´ë™
        async prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                await this.applyFilters();
            }
        },
        
        async nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                await this.applyFilters();
            }
        },
        
        async goToPage(page) {
            this.currentPage = page;
            await this.applyFilters();
        },
        
        getPageNumbers() {
            const pages = [];
            const start = Math.max(1, this.currentPage - 2);
            const end = Math.min(this.totalPages, this.currentPage + 2);
            
            for (let i = start; i <= end; i++) {
                pages.push(i);
            }
            
            return pages;
        },
        
        // ì°¨íŠ¸ ì´ˆê¸°í™”
        initializeCharts() {
            this.initStockStatusChart();
            this.initCategoryChart();
            this.initTrendChart();
        },
        
        // ì¬ê³  ìƒíƒœ ë¶„í¬ ì°¨íŠ¸
        async initStockStatusChart() {
            try {
                const response = await fetch(`{% url 'reports:inventory_chart_data' %}?type=stock_status`);
                const result = await response.json();
                
                if (result.success) {
                    const ctx = document.getElementById('stockStatusChart').getContext('2d');
                    this.charts.stockStatus = new Chart(ctx, {
                        type: 'doughnut',
                        data: result.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('ì¬ê³  ìƒíƒœ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        },
        
        // ì¹´í…Œê³ ë¦¬ë³„ ì¬ê³  ê°€ì¹˜ ì°¨íŠ¸
        async initCategoryChart() {
            try {
                const response = await fetch(`{% url 'reports:inventory_chart_data' %}?type=category_value`);
                const result = await response.json();
                
                if (result.success) {
                    const ctx = document.getElementById('categoryChart').getContext('2d');
                    this.charts.category = new Chart(ctx, {
                        type: 'bar',
                        data: result.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value + 'ë°±ë§Œì›';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        },
        
        // ì¬ê³  ë³€ë™ ì¶”ì´ ì°¨íŠ¸
        async initTrendChart() {
            try {
                const response = await fetch(`{% url 'reports:inventory_chart_data' %}?type=trend&days=${this.trendPeriod}`);
                const result = await response.json();
                
                if (result.success) {
                    const ctx = document.getElementById('trendChart').getContext('2d');
                    this.charts.trend = new Chart(ctx, {
                        type: 'line',
                        data: result.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return value + 'ë°±ë§Œì›';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('ì¶”ì´ ì°¨íŠ¸ ì˜¤ë¥˜:', error);
            }
        },
        
        // ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        async updateTrendChart() {
            try {
                const response = await fetch(`{% url 'reports:inventory_chart_data' %}?type=trend&days=${this.trendPeriod}`);
                const result = await response.json();
                
                if (result.success && this.charts.trend) {
                    this.charts.trend.data = result.data;
                    this.charts.trend.update();
                }
            } catch (error) {
                console.error('ì¶”ì´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        },
        
        // ì°¨íŠ¸ íƒ€ì… ë³€ê²½
        toggleChartType(chartName) {
            if (chartName === 'categoryChart') {
                const chart = this.charts.category;
                chart.config.type = chart.config.type === 'bar' ? 'pie' : 'bar';
                chart.update();
            }
        },
        
        // ì•Œë¦¼ ë¡œë“œ
        async loadAlerts() {
            try {
                const response = await fetch(`{% url 'reports:inventory_alerts' %}`);
                const result = await response.json();
                
                if (result.success) {
                    this.alerts = result.alerts;
                }
            } catch (error) {
                console.error('ì•Œë¦¼ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        },
        
        // ì•Œë¦¼ í•´ê²°
        resolveAlert(alertId) {
            this.alerts = this.alerts.filter(alert => alert.id !== alertId);
            this.showSuccess('ì•Œë¦¼ì´ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        },
        
        // ì•Œë¦¼ ë¬´ì‹œ
        dismissAlert(alertId) {
            this.alerts = this.alerts.filter(alert => alert.id !== alertId);
        },
        
        // ë¦¬í¬íŠ¸ ìƒˆë¡œê³ ì¹¨
        async refreshReport() {
            this.loading = true;
            try {
                await this.loadReportData();
                this.updateAllCharts();
                this.showSuccess('ë¦¬í¬íŠ¸ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
                this.showError('ìƒˆë¡œê³ ì¹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                this.loading = false;
            }
        },
        
        // ëª¨ë“  ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        updateAllCharts() {
            Object.values(this.charts).forEach(chart => {
                if (chart && typeof chart.update === 'function') {
                    chart.update();
                }
            });
        },
        
        // ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°
        async exportReport(format) {
            this.loading = true;
            try {
                if (format === 'excel') {
                    await this.exportToExcel();
                } else if (format === 'pdf') {
                    await this.exportToPDF();
                }
                this.showSuccess(`${format.toUpperCase()} íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                console.error('ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                this.showError('ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                this.loading = false;
            }
        },
        
        // Excel ë‚´ë³´ë‚´ê¸°
        async exportToExcel() {
            try {
                // í˜„ì¬ í•„í„° ìƒíƒœë¥¼ í¬í•¨í•œ ë°ì´í„° ì „ì†¡
                const exportData = {
                    filters: this.filters,
                    search: this.searchQuery
                };
                
                const response = await fetch(`{% url 'reports:export_inventory' %}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrf-token]').content,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(exportData)
                });
                
                if (response.ok) {
                    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `inventory_report_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Excel ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                this.showError('Excel ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        },
        
        // PDF ë‚´ë³´ë‚´ê¸°
        async exportToPDF() {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡í•˜ì—¬ PDF íŒŒì¼ ìƒì„±
            console.log('PDF ë‚´ë³´ë‚´ê¸°');
        },
        
        // ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ
        formatNumber(value) {
            return parseInt(value).toLocaleString('ko-KR');
        },
        
        formatCurrency(value) {
            return 'â‚©' + parseInt(value).toLocaleString('ko-KR');
        },
        
        formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        getStatusClass(status) {
            const classes = {
                'normal': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
                'low': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
                'out': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
                'excess': 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300'
            };
            return classes[status] || classes.normal;
        },
        
        getStatusIndicatorClass(status) {
            const classes = {
                'normal': 'bg-green-500',
                'low': 'bg-yellow-500',
                'out': 'bg-red-500',
                'excess': 'bg-purple-500'
            };
            return classes[status] || classes.normal;
        },
        
        getStatusText(status) {
            const texts = {
                'normal': 'ì •ìƒ',
                'low': 'ë¶€ì¡±',
                'out': 'í’ˆì ˆ',
                'excess': 'ê³¼ì¬ê³ '
            };
            return texts[status] || 'ì •ìƒ';
        },
        
        // ì•Œë¦¼ ë©”ì„œë“œ
        showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: 'ì„±ê³µ',
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        },
        
        showError(message) {
            Swal.fire({
                icon: 'error',
                title: 'ì˜¤ë¥˜',
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        }
    }
}
</script>
{% endblock %}