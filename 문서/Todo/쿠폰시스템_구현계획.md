# 쿠폰 시스템 상세 구현 계획

## 1. 쿠폰 시스템 개요

### 1.1 목적
- 고객 유치 및 재구매 유도
- 프로모션 및 마케팅 캠페인 지원
- 고객 만족도 향상 및 매출 증대

### 1.2 주요 기능
- 다양한 쿠폰 타입 지원 (정액/정률/무료배송)
- 쿠폰 발급 방식 다양화 (자동/수동/이벤트)
- 쿠폰 사용 조건 및 제한 설정
- 쿠폰 통계 및 분석

## 2. 데이터베이스 설계

### 2.1 Coupon 모델
```python
class Coupon(models.Model):
    """쿠폰 정보"""
    
    DISCOUNT_TYPE_CHOICES = [
        ('FIXED', '정액 할인'),
        ('PERCENTAGE', '정률 할인'),
        ('FREE_SHIPPING', '무료 배송'),
        ('BOGO', '1+1/2+1'),
    ]
    
    ISSUE_TYPE_CHOICES = [
        ('PUBLIC', '공개 쿠폰'),
        ('PRIVATE', '개인 쿠폰'),
        ('WELCOME', '회원가입 쿠폰'),
        ('BIRTHDAY', '생일 쿠폰'),
        ('COMEBACK', '휴면 복귀 쿠폰'),
        ('VIP', 'VIP 전용 쿠폰'),
    ]
    
    # 기본 정보
    code = models.CharField('쿠폰 코드', max_length=50, unique=True, db_index=True)
    name = models.CharField('쿠폰명', max_length=200)
    description = models.TextField('설명', blank=True)
    
    # 할인 정보
    discount_type = models.CharField('할인 타입', max_length=20, choices=DISCOUNT_TYPE_CHOICES)
    discount_value = models.DecimalField('할인 값', max_digits=10, decimal_places=2)
    max_discount_amount = models.DecimalField('최대 할인 금액', max_digits=10, decimal_places=2, null=True, blank=True)
    
    # 사용 조건
    min_order_amount = models.DecimalField('최소 주문 금액', max_digits=10, decimal_places=2, default=0)
    applicable_categories = models.ManyToManyField('products.Category', blank=True, verbose_name='적용 카테고리')
    applicable_products = models.ManyToManyField('products.Product', blank=True, verbose_name='적용 상품')
    exclude_sale_items = models.BooleanField('세일 상품 제외', default=False)
    
    # 발급 정보
    issue_type = models.CharField('발급 타입', max_length=20, choices=ISSUE_TYPE_CHOICES)
    total_quantity = models.IntegerField('총 발급 수량', null=True, blank=True)
    issued_quantity = models.IntegerField('발급된 수량', default=0)
    
    # 사용 제한
    usage_limit_total = models.IntegerField('전체 사용 제한', null=True, blank=True)
    usage_limit_per_user = models.IntegerField('사용자별 사용 제한', default=1)
    used_count = models.IntegerField('사용된 횟수', default=0)
    
    # 유효 기간
    valid_from = models.DateTimeField('유효 시작일')
    valid_to = models.DateTimeField('유효 종료일')
    days_valid_after_issue = models.IntegerField('발급 후 유효 일수', null=True, blank=True)
    
    # 대상 설정
    target_membership_levels = models.JSONField('대상 회원 등급', default=list, blank=True)
    target_users = models.ManyToManyField('accounts.User', blank=True, verbose_name='대상 사용자')
    
    # 상태
    is_active = models.BooleanField('활성 상태', default=True)
    is_stackable = models.BooleanField('다른 쿠폰과 중복 사용', default=False)
    
    # 메타 정보
    created_at = models.DateTimeField('생성일', auto_now_add=True)
    created_by = models.ForeignKey('accounts.User', on_delete=models.SET_NULL, null=True, related_name='created_coupons')
    updated_at = models.DateTimeField('수정일', auto_now=True)
```

### 2.2 UserCoupon 모델
```python
class UserCoupon(models.Model):
    """사용자별 쿠폰 발급 내역"""
    
    STATUS_CHOICES = [
        ('ISSUED', '발급됨'),
        ('USED', '사용됨'),
        ('EXPIRED', '만료됨'),
    ]
    
    user = models.ForeignKey('accounts.User', on_delete=models.CASCADE, related_name='user_coupons')
    coupon = models.ForeignKey(Coupon, on_delete=models.CASCADE, related_name='user_coupons')
    
    status = models.CharField('상태', max_length=20, choices=STATUS_CHOICES, default='ISSUED')
    
    issued_at = models.DateTimeField('발급일', auto_now_add=True)
    used_at = models.DateTimeField('사용일', null=True, blank=True)
    expires_at = models.DateTimeField('만료일')
    
    order = models.ForeignKey('orders.Order', on_delete=models.SET_NULL, null=True, blank=True, related_name='used_coupons')
    
    class Meta:
        unique_together = ['user', 'coupon', 'issued_at']
```

### 2.3 CouponLog 모델
```python
class CouponLog(models.Model):
    """쿠폰 활동 로그"""
    
    ACTION_CHOICES = [
        ('CREATED', '생성'),
        ('ISSUED', '발급'),
        ('USED', '사용'),
        ('EXPIRED', '만료'),
        ('CANCELLED', '취소'),
    ]
    
    coupon = models.ForeignKey(Coupon, on_delete=models.CASCADE, related_name='logs')
    user = models.ForeignKey('accounts.User', on_delete=models.SET_NULL, null=True, blank=True)
    action = models.CharField('액션', max_length=20, choices=ACTION_CHOICES)
    details = models.JSONField('상세 정보', default=dict)
    created_at = models.DateTimeField('발생일', auto_now_add=True)
```

## 3. 주요 기능 구현

### 3.1 쿠폰 발급 시스템

#### 자동 발급
```python
def auto_issue_coupon(user, issue_type):
    """특정 이벤트 시 자동 쿠폰 발급"""
    
    # 발급 가능한 쿠폰 조회
    coupons = Coupon.objects.filter(
        issue_type=issue_type,
        is_active=True,
        valid_from__lte=timezone.now(),
        valid_to__gte=timezone.now()
    )
    
    for coupon in coupons:
        # 발급 조건 확인
        if check_issue_conditions(user, coupon):
            issue_coupon_to_user(coupon, user)
```

#### 수동 발급 (코드 입력)
```python
def issue_coupon_by_code(user, coupon_code):
    """쿠폰 코드로 수동 발급"""
    
    try:
        coupon = Coupon.objects.get(
            code=coupon_code.upper(),
            is_active=True
        )
        
        # 유효성 검증
        if validate_coupon_issue(coupon, user):
            return issue_coupon_to_user(coupon, user)
        
    except Coupon.DoesNotExist:
        return {'success': False, 'message': '유효하지 않은 쿠폰 코드입니다.'}
```

### 3.2 쿠폰 사용 검증

```python
def validate_coupon_usage(user_coupon, order_amount, products):
    """쿠폰 사용 가능 여부 검증"""
    
    coupon = user_coupon.coupon
    
    # 1. 만료 확인
    if user_coupon.expires_at < timezone.now():
        return False, "쿠폰이 만료되었습니다."
    
    # 2. 상태 확인
    if user_coupon.status != 'ISSUED':
        return False, "이미 사용되었거나 유효하지 않은 쿠폰입니다."
    
    # 3. 최소 주문 금액 확인
    if order_amount < coupon.min_order_amount:
        return False, f"최소 주문 금액 {coupon.min_order_amount}원 이상에서 사용 가능합니다."
    
    # 4. 적용 가능 상품/카테고리 확인
    if not check_applicable_products(coupon, products):
        return False, "해당 상품에는 쿠폰을 사용할 수 없습니다."
    
    # 5. 세일 상품 제외 확인
    if coupon.exclude_sale_items and has_sale_items(products):
        return False, "세일 상품에는 쿠폰을 사용할 수 없습니다."
    
    return True, "사용 가능"
```

### 3.3 할인 금액 계산

```python
def calculate_discount(coupon, order_amount, products):
    """쿠폰 할인 금액 계산"""
    
    discount_amount = 0
    
    if coupon.discount_type == 'FIXED':
        # 정액 할인
        discount_amount = coupon.discount_value
        
    elif coupon.discount_type == 'PERCENTAGE':
        # 정률 할인
        applicable_amount = get_applicable_amount(coupon, products)
        discount_amount = applicable_amount * (coupon.discount_value / 100)
        
        # 최대 할인 금액 적용
        if coupon.max_discount_amount:
            discount_amount = min(discount_amount, coupon.max_discount_amount)
            
    elif coupon.discount_type == 'FREE_SHIPPING':
        # 무료 배송
        discount_amount = get_shipping_fee()
        
    elif coupon.discount_type == 'BOGO':
        # 1+1, 2+1 등
        discount_amount = calculate_bogo_discount(coupon, products)
    
    # 할인 금액이 주문 금액을 초과하지 않도록
    return min(discount_amount, order_amount)
```

## 4. API 엔드포인트

### 4.1 사용자 API
```
GET /api/coupons/my/              # 내 쿠폰 목록
POST /api/coupons/issue/           # 쿠폰 코드로 발급
GET /api/coupons/available/        # 사용 가능한 쿠폰 목록
POST /api/coupons/validate/        # 쿠폰 유효성 검증
POST /api/coupons/calculate/       # 할인 금액 계산
```

### 4.2 관리자 API
```
GET /api/admin/coupons/            # 쿠폰 목록
POST /api/admin/coupons/           # 쿠폰 생성
PUT /api/admin/coupons/{id}/       # 쿠폰 수정
DELETE /api/admin/coupons/{id}/    # 쿠폰 삭제
POST /api/admin/coupons/issue/     # 쿠폰 발급 (대상 지정)
GET /api/admin/coupons/stats/      # 쿠폰 통계
```

## 5. 관리자 페이지 기능

### 5.1 쿠폰 관리
- 쿠폰 CRUD
- 쿠폰 코드 자동 생성
- 대량 쿠폰 발급
- 쿠폰 복사 기능
- 쿠폰 미리보기

### 5.2 쿠폰 통계
- 발급/사용 현황
- 쿠폰별 매출 기여도
- 사용자별 쿠폰 사용 패턴
- 쿠폰 ROI 분석

### 5.3 쿠폰 템플릿
- 자주 사용하는 쿠폰 템플릿 저장
- 시즌별 쿠폰 세트 관리

## 6. 구현 일정

### Week 1
- [ ] 데이터베이스 모델 생성
- [ ] 마이그레이션 실행
- [ ] 기본 CRUD API 구현

### Week 2
- [ ] 쿠폰 발급 로직 구현
- [ ] 쿠폰 검증 로직 구현
- [ ] 할인 계산 로직 구현

### Week 3
- [ ] 관리자 페이지 구현
- [ ] 사용자 페이지 통합
- [ ] 주문 프로세스 통합

### Week 4
- [ ] 테스트 코드 작성
- [ ] 성능 최적화
- [ ] 문서화

## 7. 테스트 시나리오

### 7.1 단위 테스트
- 쿠폰 생성/수정/삭제
- 쿠폰 발급 조건 확인
- 할인 금액 계산
- 유효성 검증

### 7.2 통합 테스트
- 주문 프로세스에서 쿠폰 적용
- 쿠폰 중복 사용 방지
- 동시성 테스트 (대량 발급)

### 7.3 시나리오 테스트
1. 회원가입 → 웰컴 쿠폰 자동 발급
2. 생일 → 생일 쿠폰 자동 발급
3. 쿠폰 코드 입력 → 발급 → 주문 시 사용
4. VIP 등급 달성 → VIP 전용 쿠폰 발급

## 8. 보안 고려사항

- SQL Injection 방지
- 쿠폰 코드 무작위 대입 방지 (Rate limiting)
- 쿠폰 중복 사용 방지 (트랜잭션 처리)
- 관리자 권한 체크

## 9. 성능 최적화

- 쿠폰 조회 쿼리 최적화 (인덱스)
- Redis 캐싱 활용
- 배치 처리 (대량 발급/만료 처리)

## 10. 추후 확장 기능

- QR코드 쿠폰
- 쿠폰 선물하기
- 그룹 쿠폰 (친구와 공유)
- 게임화 쿠폰 (룰렛, 스크래치)
- AI 기반 개인화 쿠폰 추천

---

*작성일: 2025년 8월 18일*
*작성자: Claude Code Assistant*